---
- name: check initialization
  stat:
    path: /usr/local/etc/ox-init
  register: initialized

- block:
    # this had to be done because the ox initializing-scripts are not idempotent
    - name: read mysql root password
      slurp:
        src: /usr/local/etc/mysql-password
      register: mysql_root_password

    - name: Ensure the configdb database is initialized
      command: |
              /opt/open-xchange/sbin/initconfigdb -i -a --configdb-pass={{ ubuntu.ox.user['oxuser'].password }}
              --mysql-root-passwd={{ mysql_root_password['content'] | b64decode | replace('\n', '') }}

    - name: Ensure OpenXChange is configured without a license
      command: |
              /opt/open-xchange/sbin/oxinstaller --no-license --servername={{ inventory_hostname }}
              --configdb-pass={{ ubuntu.ox.user['oxuser'].password }}
              --master-pass={{ ubuntu.ox.user['oxadminmaster'].password }} --network-listener-host=localhost
              --servermemory "{{ ubuntu.ox.java.vm.memory}}"
      when: ubuntu.ox.license is undefined

    - name: Ensure OpenXChange is configured with license
      command: |
              /opt/open-xchange/sbin/oxinstaller --add-license=YOUR-OX-LICENSE-CODE
              --servername={{ inventory_hostname }} --configdb-pass={{ ubuntu.ox.user['oxuser'].password }}
              --master-pass={{ ubuntu.ox.user['oxadminmaster'].password }} --network-listener-host=localhost
              --servermemory "{{ ubuntu.ox.java.vm.memory}}"
      when: ubuntu.ox.license is defined

    - name: touch file to indicate initialization
      file:
        path: /usr/local/etc/ox-init
        owner: root
        group: root
        mode: 0644
        state: touch
  when: initialized.stat.exists == False
